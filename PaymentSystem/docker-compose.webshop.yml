# WebShop Stack - samo WebShop frontend, backend i baza
# Pokreće se na jednom računaru/laptopu

version: '3.8'

services:
  # PostgreSQL baza za WebShop
  postgres-webshop:
    image: postgres:15-alpine
    container_name: webshop-db
    environment:
      - POSTGRES_DB=webshop
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_WEBSHOP_PASSWORD}
    volumes:
      - postgres-webshop-data:/var/lib/postgresql/data
    networks:
      - webshop-network
    ports:
      - "5435:5432"  # Expose za backup/maintenance
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d webshop"]
      interval: 10s
      timeout: 5s
      retries: 5

  # WebShop API Backend
  webshop-api:
    build:
      context: ./backend
      dockerfile: WebShop/WebShop.API/Dockerfile
    container_name: webshop-api
    depends_on:
      postgres-webshop:
        condition: service_healthy
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres-webshop;Database=webshop;Username=postgres;Password=${POSTGRES_WEBSHOP_PASSWORD};Port=5432
      - ASPNETCORE_URLS=https://+:443
      - Https__CertificatePath=/app/certs/webshop-api.pfx
      - Https__CertificatePassword=dev-cert-2024
      - PSP__ApiUrl=${PSP_EXTERNAL_URL:-https://psp-lb:443}/api
      - PSP__MerchantId=${PSP_MERCHANT_ID}
      - PSP__ApiKey=${PSP_API_KEY}
      - Jwt__SecretKey=${JWT_SECRET_KEY}
    volumes:
      - ./certs:/app/certs:ro
    networks:
      - webshop-network
    ports:
      - "5440:443"  # HTTPS

  # WebShop Frontend
  frontend-webshop:
    build:
      context: ./frontend/webshop
      dockerfile: Dockerfile
    container_name: frontend-webshop
    depends_on:
      - webshop-api
    environment:
      - VITE_PSP_API_URL=${PSP_EXTERNAL_URL:-https://psp-lb:443}/api
      - VITE_WEBSHOP_API_URL=https://webshop-api:443/api
    volumes:
      - ./certs/localhost+2.pem:/app/certs/localhost+2.pem:ro
      - ./certs/localhost+2-key.pem:/app/certs/localhost+2-key.pem:ro
    networks:
      - webshop-network
    ports:
      - "5173:5173"  # HTTPS

networks:
  webshop-network:
    driver: bridge

volumes:
  postgres-webshop-data:
